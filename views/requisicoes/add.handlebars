<h2>Criar requisição</h2>
<hr>
<div id="app-insumos">
<div class="card">
    <div class="card-body">
        <div >
			Escolha as colunas:
            
            <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
            <label class="btn btn-secondary active">
                <input type="checkbox" name="options" autocomplete="on" checked>
                <a class="toggle-vis" data-column="0">Origem</a>
            </label>
            <label class="btn btn-secondary active">
                <input type="checkbox" name="options" autocomplete="on" checked>
                <a class="toggle-vis" data-column="1">Código</a>
            </label>
            <label class="btn btn-secondary active">
                <input type="checkbox" name="options" autocomplete="on" checked>
                <a class="toggle-vis" data-column="2">Descrição</a>
            </label>
            <label class="btn btn-secondary active">
                <input type="checkbox" name="options" autocomplete="on" checked>
                <a class="toggle-vis" data-column="3">Unidade</a>
            </label>
            <label class="btn btn-secondary active">
                <input type="checkbox" name="options" autocomplete="on" checked>
                <a class="toggle-vis" data-column="4">Preço</a>
            </label>
            <label class="btn btn-secondary active">
                <input type="checkbox" name="options" autocomplete="on" checked>
                <a class="toggle-vis" data-column="5">Observações</a>
            </label>
            </div>      
		</div>
        <table id="table-insumos" style="font-size:13px" class="table table-striped table-bordered table-sm" style="width:100%"> <!-- table table-striped table-sm | table table-striped table-bordered -->
            <thead class="thead-dark">
                <tr>
                    <th>Origem</th>
                    <th>Código</th>
                    <th>Descrição</th>
                    <th>Unidade</th>
                    <th>Preço</th>
                    <th>Observações</th>
                    <th >Ações</th>
                </tr>
            </thead>
            <div id="spinner-insumos"class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <tbody id="tbody-insumos" hidden>   
                        
                {{#each insumos}}
                <tr id="{{_id}}">
                    <td>{{origem.nome}}</td>
                    <td>{{codigo_origem}}</td>
                    <td>{{descricao}}</td>
                    <td>{{unidade_medida}}</td>
                    <td>{{preco_mediano}}</td>
                    <td>{{observacao}}</td>
                    <td> 
                        <button v-on:click="adicionar('{{_id}}')"><i class="material-icons">add_circle</i></button>                           
                    </td>
                </tr>
                {{else}}
                <tr>
                <td><h5>Nenhum insumo cadastrado.</h5></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                </tr>
                {{/each}}            
            </tbody>    
        </table>
    </div>
    <hr>
</div>
<br>

    <div class="card">
        
        <div class="card-body">
                <h4>Escolha os ítens </h4>
        <table style="font-size:13px" class="table table-striped table-bordered table-sm">
                <thead class="thead-dark">
                    <tr>                            
                        <th>Código</th>
                        <th>Descrição</th>
                        <th>Unidade</th>
                        <th>Quant.</th>
                        <th>Preço</th>
                        <th>Total</th>
                        <th >Ações</th>
                    </tr>
            
            <tbody>
                
                <tr v-for="(insumo, index) in insumos">
                        <td>\{{insumo.nome}}.\{{insumo.codigo}}</td>
                        <td>\{{insumo.descricao}}</td>
                        <td>\{{insumo.unidade}}</td>
                        <td><input type="number"  v-model.number="insumo.quantidade" name="" id="" value=""></td>
                        <td>\{{insumo.preco}}</td>
                        <td>\{{insumo.total}}</td>
                        <td><button v-on:click="remove(index)"><i class="material-icons">remove_circle</i></button></td>

                </tr>

            </tbody>
            </table>
            <p v-if="insumos.length === 0">Adicione um insumo.</p>
            <div>
                <a href="/requisicoes/enviar"><button class="btn btn-success">Enviar</button></a>
                <a href="/requisicoes/salvar"><button class="btn btn-primary">Salvar</button></a>
            </div>
        </div>
        
    </div>
</div>

<script>
        appInsumos = new Vue({
            el: "#app-insumos",
            data: {
                insumos: [

                ]

            },
            methods: {
                remove: function (index){
                    console.log("Apague" + index)
                    this.insumos.splice(index, 1)
                },

                adicionar: function (id){
                    if(!this.insumos.some(insumo => (insumo.id_insumo === id))){ // verifica se o insumo já está na lista de insumos escolhidos.
                        var rowOrigem = document.getElementById(id)
                        var listaNodesOrigem = rowOrigem.children
                        var nomeOrigem = listaNodesOrigem[0].innerHTML
                        var codigoOrigem = listaNodesOrigem[1].innerHTML
                        var descricaoOrigem = listaNodesOrigem[2].innerHTML
                        var unidadeOrigem = listaNodesOrigem[3].innerHTML
                        var precoOrigem = listaNodesOrigem[4].innerHTML

                        var novo_insumo = { id_insumo: id,
                                            codigo: codigoOrigem,
                                            nome:  nomeOrigem,
                                            descricao: descricaoOrigem,
                                            quantidade: 1,
                                            unidade: unidadeOrigem,
                                            preco: parseFloat(precoOrigem),                                        
                                            }
                        var total = novo_insumo.quantidade * novo_insumo.preco
                        novo_insumo.total = total

                        this.insumos.push(novo_insumo)
                    }
                    
                }                       
            }
        })

        function adicionar_item(id) {
            var rowOrigem = document.getElementById(id)
            var listaNodesOrigem = rowOrigem.children
            var nomeOrigem = listaNodesOrigem[0].innerHTML
            var codigoOrigem = listaNodesOrigem[1].innerHTML
            var descricaoOrigem = listaNodesOrigem[2].innerHTML
            var unidadeOrigem = listaNodesOrigem[3].innerHTML
            var precoOrigem = listaNodesOrigem[4].innerHTML

            var novo_insumo = { id_insumo: id,
                                codigo: codigoOrigem,
                                nome:  nomeOrigem,
                                descricao: descricaoOrigem,
                                quantidade: 0,
                                unidade: unidadeOrigem,
                                preco: precoOrigem
                                }

                appInsumos.insumos.push(novo_insumo)
            }

        function remover_item(index){
            console.log("Apague" + index)
            this.insumos.splice(index, 1)
        }

        $(document).ready( function () {
        var table = $('#table-insumos').DataTable({
            "scrollY": "200px",
            "paging": true
            //"processing": true
            });
        document.getElementById("tbody-insumos").classList.add('visible');        
        document.getElementById("tbody-insumos").removeAttribute('hidden')
        document.getElementById("spinner-insumos").remove();
        
        $('a.toggle-vis').on( 'click', function (e) {
            e.preventDefault();
    
            // Get the column API object
            var column = table.column( $(this).attr('data-column') );
    
            // Toggle the visibility
            column.visible( ! column.visible() );
        });
    });

        
    </script>