<h2>Criar requisição</h2>
<hr>
{{contrato}}
<div id="app-insumos">
    <div class="card">
        <div class="card-body">
            <!-- Escolha as colunas Desativado por problemas na adição de insumos
            <div >
                Escolha as colunas:
                
                <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                <label class="btn btn-secondary active">
                    <input type="checkbox" name="options" autocomplete="on" checked>
                    <a class="toggle-vis" data-column="0">Origem</a>
                </label>
                <label class="btn btn-secondary active">
                    <input type="checkbox" name="options" autocomplete="on" checked>
                    <a class="toggle-vis" data-column="1">Código</a>
                </label>
                <label class="btn btn-secondary active">
                    <input type="checkbox" name="options" autocomplete="on" checked>
                    <a class="toggle-vis" data-column="2">Descrição</a>
                </label>
                <label class="btn btn-secondary active">
                    <input type="checkbox" name="options" autocomplete="on" checked>
                    <a class="toggle-vis" data-column="3">Unidade</a>
                </label>
                <label class="btn btn-secondary active">
                    <input type="checkbox" name="options" autocomplete="on" checked>
                    <a class="toggle-vis" data-column="4">Preço</a>
                </label>
                <label class="btn btn-secondary active">
                    <input type="checkbox" name="options" autocomplete="on" checked>
                    <a class="toggle-vis" data-column="5">Observações</a>
                </label>
                </div>      
            </div>
            -->
            <table id="table-insumos" style="font-size:13px" class="table table-striped table-bordered table-sm" style="width:100%">
                <thead class="thead-dark">
                    <tr>
                        <th>Origem</th>
                        <th>Código</th>
                        <th>Descrição</th>
                        <th>Unidade</th>
                        <th>Preço</th>
                        <th>Observações</th>
                        <th >Ações</th>
                    </tr>
                </thead>
                <div id="spinner-insumos"class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
                <tbody id="tbody-insumos" hidden>   
                            
                    {{#each insumos}}
                    <tr id="{{_id}}">
                        <td>{{origem.nome}}</td>
                        <td>{{codigo_origem}}</td>
                        <td>{{descricao}}</td>
                        <td>{{unidade_medida}}</td>
                        <td>{{preco_mediano}}</td>
                        <td>{{observacao}}</td>
                        <td> 
                            <button v-on:click="adicionar('{{_id}}')"><i class="material-icons md-18">add_circle</i></button>                           
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                    <td><h5>Nenhum insumo cadastrado.</h5></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    </tr>
                    {{/each}}            
                </tbody>    
            </table>
        </div>
    </div>
    <br>
    <div class="card">
        <form>
            <div class="card-body">
                <h4>Escolha os ítens </h4>
            
            <table style="font-size:13px" class="table table-striped table-bordered table-sm">
                    <thead class="thead-dark">
                        <tr>                            
                            <th>Código</th>
                            <th>Descrição</th>
                            <th>Unidade</th>
                            <th>Quant.</th>
                            <th>Preço</th>
                            <th>Total</th>
                            <th >Ações</th>
                        </tr>  
                </thead>              
                <tbody>                    
                    <tr v-for="(insumo, index) in insumos">
                            <td>\{{insumo.nome}}.\{{insumo.codigo}}</td>
                            <td>\{{insumo.descricao}}</td>
                            <td>\{{insumo.unidade}}</td>
                            <td><input type="number"  v-model.number="insumo.quantidade" name="" id="" value=""></td>
                            <td>\{{insumo.preco}}</td>
                            <td>\{{insumo.preco * insumo.quantidade || 0}}</td>
                            <td><button v-on:click="remove(index)"><i class="material-icons md-18">remove_circle</i></button></td>
                    </tr>

                </tbody>
                </table>
                <h5 v-if="insumos.length === 0">Adicione um insumo.</h5>
                <div class="form-group">
                    <!-- //Valor total da requisicao
                    <label for="valor_total">Total: </label>
                        <input type="number" name="" id="valor_total" v-model.number="valor_total">
                    -->
                    <hr>
                    <label for="observacoes">Observações: </label>
                        <textarea v-model="observacoes" class="form-control" name="" id="observacoes" cols="30" rows="3"></textarea></br>
                    <label for="contrato">Contrato: </label>
                        <select class="form-control" name="" id="contrato" disabled></select></br>
                    <label for="solicitante">Solicitante: </label>
                        <select class="form-control" name="" id="solicitante" disabled></select>

                </div>
            
                <div>
                    <button class="btn btn-success" v-on:click="enviar()">Enviar</button>
                    <button class="btn btn-primary" @click="salvar()">Salvar</button>
                </div>
                {{!-- Loading enquanto carrega --}}
                <div v-if="loading">Carregando...</div>

                {{!-- Mensagem de sucesso --}}
                <div v-if="message">\{{message}}</div>
            </div>
        </form>
    </div>
</div>

<script>
    // Vue
    appRequisicoes = new Vue({
        el: "#app-insumos",
        data: {
            insumos: [

            ],
            valor_total: 0,
            observacoes: '',
            message: '',
            loading: false
        },
        methods: {
            remove: function (index){                
                this.insumos.splice(index, 1)
            },
            adicionar: function (id){
                if(!this.insumos.some(insumo => (insumo.id === id))){ // verifica se o insumo já está na lista de insumos escolhidos.
                    var rowOrigem = document.getElementById(id) //pega a linha do item
                    var listaNodesOrigem = rowOrigem.children //
                    var nomeOrigem = listaNodesOrigem[0].innerHTML
                    var codigoOrigem = listaNodesOrigem[1].innerHTML
                    var descricaoOrigem = listaNodesOrigem[2].innerHTML
                    var unidadeOrigem = listaNodesOrigem[3].innerHTML
                    var precoOrigem = listaNodesOrigem[4].innerHTML

                    var novo_insumo = { id: id,
                                        codigo: codigoOrigem,
                                        nome:  nomeOrigem,
                                        descricao: descricaoOrigem,
                                        quantidade: 1,
                                        unidade: unidadeOrigem,
                                        preco: parseFloat(precoOrigem),                                        
                                        }
                    this.insumos.push(novo_insumo)
                }                    
            },

            async enviar() {
                this.loading = true
                // Calcular valor_total da requisição
                this.valor_total = 0                    
                    for(var i = 0; i < this.insumos.length; i++){
                        this.valor_total += (this.insumos[i].quantidade * this.insumos[i].preco)
                    }
                if(this.insumos.length > 0){
                    const insumos = this.insumos.map(row => ({id: row.id, quantidade: row.quantidade}))
                    const obs = this.observacoes
                    const requisicao = {}
                    requisicao.insumos = insumos
                    requisicao.obs = obs
                    requisicao.valor_total = this.valor_total
                    setTimeout(() => {  },200000)
                    const url = '/requisicoes/enviar'
                    console.log(requisicao)
                    const resultado = await axios.post(url, requisicao)
                    this.loading = false
                    window.location.href = '/requisicoes'
                }else{
                    console.log("Adicione itens.")
                }
                //this.menssage = resultado.data.message              
            },
            async salvar() {
                this.loading = true
                if(this.insumos.length > 0){ // Verifica se existem itens na requisicao.
                    // Calcula valor_total da requisição
                    this.valor_total = 0                    
                    for(var i = 0; i < this.insumos.length; i++){
                        this.valor_total += (this.insumos[i].quantidade * this.insumos[i].preco)
                    }                    
                    const insumos = this.insumos.map(row => ({id: row.id, quantidade: row.quantidade}))
                    const data = {}
                    data.insumos = insumos
                    data.obs = this.observacoes
                    data.valor_total = this.valor_total
                    const url = '/requisicoes/salvar'
                    const resultado = await axios.post(url, data)
                    this.loading = false
                    window.location.href = '/requisicoes'
                    //this.menssage = resultado.data.message
                }else{
                    console.log("Adicione itens.")
                }
                
            }

        }
    })

    // Datatables
    $(document).ready( () => {
        var table = $('#table-insumos').DataTable({
            "scrollY": "200px",
            "paging": true
            //"processing": true
            });
        document.getElementById("tbody-insumos").classList.add('visible');        
        document.getElementById("tbody-insumos").removeAttribute('hidden')
        document.getElementById("spinner-insumos").remove();
        
        $('a.toggle-vis').on( 'click', function (e) {
            e.preventDefault();

            // Get the column API object
            var column = table.column( $(this).attr('data-column') );

            // Toggle the visibility
            column.visible( ! column.visible() );
        });
    });        
</script>